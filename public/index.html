<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Severi - CRM Integration</title>
        <link rel="stylesheet" href="/style.css" />
    </head>
    <body>
        <header>
            <img src="/logo%20Severi.png" alt="Severi Logo" />
            <h1>Severi - CRM Integration</h1>
        </header>
        <div class="container">
            <!-- Menù a tendina per la selezione del cliente -->
            <h2>Seleziona un Cliente</h2>
            <div class="custom-select">
                <select id="clientSelect">
                    <option value="">-- Seleziona un cliente --</option>
                </select>
            </div>

            <!-- Tabella dei contratti attivi -->
            <h2>Contratti Attivi</h2>
            <table id="contractTable">
                <thead>
                    <tr>
                        <th>Articolo</th>
                        <th>Quantità</th>
                        <th>Prezzo</th>
                        <th>Totale</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dettagli verranno inseriti qui -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">Totale Generale</td>
                        <td id="totalAmount">0</td>
                    </tr>
                </tfoot>
            </table>

            <!-- Form per generare il PDF -->
            <h2>Genera PDF</h2>
            <form id="pdfForm">
                <div class="form-group">
                    <label for="ragioneSociale">Ragione Sociale</label>
                    <input type="text" id="ragioneSociale" required />
                </div>
                <div class="form-group">
                    <label for="indirizzo">Indirizzo</label>
                    <input type="text" id="indirizzo" required />
                </div>
                <div class="form-group">
                    <label for="cap">CAP</label>
                    <input type="text" id="cap" required />
                </div>
                <div class="form-group">
                    <label for="localita">Località</label>
                    <input type="text" id="localita" required />
                </div>
                <div class="form-group">
                    <label for="provincia">Provincia</label>
                    <input type="text" id="provincia" required />
                </div>
                <div class="form-group">
                    <label for="partitaIva">Partita IVA</label>
                    <input type="text" id="partitaIva" required />
                </div>
                <div class="form-group">
                    <label for="codiceFiscale">Codice Fiscale</label>
                    <input type="text" id="codiceFiscale" required />
                </div>
                <div class="form-group">
                    <label for="telefono">Telefono/Fax</label>
                    <input type="text" id="telefono" required />
                </div>
                <div class="form-group">
                    <label for="email">E-Mail</label>
                    <input type="email" id="email" required />
                </div>
                <div class="form-group">
                    <label for="banca">Banca</label>
                    <input type="text" id="banca" required />
                </div>
                <div class="form-group">
                    <label for="iban">IBAN</label>
                    <input type="text" id="iban" required />
                </div>
                <button type="submit" class="btn">Genera PDF</button>
            </form>
        </div>

        <script>
            // Funzione per mostrare un messaggio di esito
            function showMessage(message, isSuccess) {
                const messageDiv = document.getElementById("message");
                messageDiv.textContent = message;
                messageDiv.className = `message ${isSuccess ? "success" : "error"}`;
            }

            // Funzione per caricare i clienti nel menù a tendina
            async function loadClients() {
                try {
                    const token = localStorage.getItem("token");
                    if (!token) {
                        window.location.href = "/login.html"; // Reindirizza al login se non c'è un token
                        return;
                    }

                    const clientDataResponse = await fetch(
                        `/getClientData?token=${token}`,
                    );
                    if (!clientDataResponse.ok) {
                        throw new Error("Errore durante il caricamento dei clienti.");
                    }
                    const { clients } = await clientDataResponse.json();

                    const clientSelect = document.getElementById("clientSelect");
                    clientSelect.innerHTML =
                        '<option value="">-- Seleziona un cliente --</option>'; // Resetta il menù
                    clients.forEach((client) => {
                        const option = document.createElement("option");
                        option.value = client[3]; // Usa il nome del cliente come valore
                        option.textContent = client[3]; // Mostra il nome del cliente
                        clientSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Errore:", error);
                    showMessage("Errore durante il caricamento dei clienti.", false);
                }
            }

            // Funzione per visualizzare i contratti attivi del cliente selezionato
            async function displayContracts(selectedClient) {
                try {
                    const token = localStorage.getItem("token");
                    if (!token) {
                        window.location.href = "/login.html"; // Reindirizza al login se non c'è un token
                        return;
                    }

                    const clientDataResponse = await fetch(
                        `/getClientData?token=${token}`,
                    );
                    const { contracts } = await clientDataResponse.json();

                    const filteredContracts = contracts.filter(
                        (contract) => contract[3] === selectedClient,
                    );

                    const tableBody = document.querySelector("#contractTable tbody");
                    tableBody.innerHTML = "";

                    let totalAmount = 0;

                    filteredContracts.forEach((contract) => {
                        const quantity = parseFloat(contract[5]);
                        const price = parseFloat(contract[6]);
                        const total = quantity * price;

                        totalAmount += total;

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${contract[4]}</td>
                            <td>${quantity}</td>
                            <td>${price.toFixed(2)}</td>
                            <td>${total.toFixed(2)}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);

                    const clientCode = filteredContracts[0][2];
                    const clientDetailsResponse = await fetch(
                        `/getClientDetails?token=${token}&clientCode=${clientCode}`,
                    );
                    const { clientDetails } = await clientDetailsResponse.json();

                    if (!clientDetails || !Array.isArray(clientDetails)) {
                        throw new Error("Dettagli del cliente non validi o incompleti.");
                    }

                    document.getElementById("ragioneSociale").value = clientDetails[1] || "";
                    document.getElementById("indirizzo").value = clientDetails[2] || "";
                    document.getElementById("cap").value = clientDetails[3] || "";
                    document.getElementById("localita").value = clientDetails[4] || "";
                    document.getElementById("provincia").value = clientDetails[5] || "";
                    document.getElementById("partitaIva").value = clientDetails[6] || "";
                    document.getElementById("codiceFiscale").value = clientDetails[7] || "";
                    document.getElementById("telefono").value = clientDetails[8] || "";
                    document.getElementById("email").value = clientDetails[10] || "";
                    document.getElementById("banca").value = clientDetails[11] || "";
                    document.getElementById("iban").value = clientDetails[12] || "";
                } catch (error) {
                    console.error("Errore:", error);
                    showMessage("Errore durante il caricamento dei contratti o dei dettagli del cliente.", false);
                }
            }

            // Aggiungi un listener per la selezione del cliente
            document.getElementById("clientSelect").addEventListener("change", async (event) => {
                const selectedClient = event.target.value;
                if (selectedClient) {
                    await displayContracts(selectedClient);
                }
            });

            // Aggiungi un listener per il form di generazione del PDF
            document.getElementById("pdfForm").addEventListener("submit", (event) => {
                event.preventDefault();

                const ragioneSociale = document.getElementById("ragioneSociale").value;
                const indirizzo = document.getElementById("indirizzo").value;
                const cap = document.getElementById("cap").value;
                const localita = document.getElementById("localita").value;
                const provincia = document.getElementById("provincia").value;
                const partitaIva = document.getElementById("partitaIva").value;
                const codiceFiscale = document.getElementById("codiceFiscale").value;
                const telefono = document.getElementById("telefono").value;
                const email = document.getElementById("email").value;
                const banca = document.getElementById("banca").value;
                const iban = document.getElementById("iban").value;

                generatePDF(
                    ragioneSociale,
                    indirizzo,
                    cap,
                    localita,
                    provincia,
                    partitaIva,
                    codiceFiscale,
                    telefono,
                    email,
                    banca,
                    iban,
                );
            });

            // Carica i clienti all'avvio della pagina
            loadClients();
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    </body>
</html>